{% extends "base.html" %}

{% block content %}
<div class="row">
    <!-- Left Column: Source Table List -->
    <div class="col-md-4">
        <h3>Source Table <span class="badge bg-info text-dark" style="font-size: 0.6em;">{{ source_conn_name }}</span>
        </h3>
        <div class="mb-3">
            <input type="text" id="sourceSearch" class="form-control" placeholder="Search source tables...">
        </div>
        <div class="list-group" id="sourceList" style="max-height: 600px; overflow-y: auto;">
            {% for table in source_tables %}
            <a href="#" class="list-group-item list-group-item-action source-item" data-name="{{ table.table_name }}"
                data-comment="{{ table.comment or '' }}" onclick="selectSourceTable('{{ table.table_name }}')"
                style="display: none;">
                <div class="d-flex w-100 justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1">
                            {{ table.table_name }}
                            {% if table.exists_in_target %}
                            <span class="badge bg-success" style="font-size: 0.6em;">존재함</span>
                            {% endif %}
                        </h5>
                        {% if table.comment %}
                        <small class="text-muted">{{ table.comment }}</small>
                        {% endif %}
                    </div>
                    <small class="text-muted">{{ table.columns | length }} columns</small>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>

    <!-- Middle Column: Selected Table Details & Actions -->
    <div class="col-md-4">
        <h3>Action</h3>
        <div id="actionPanel" class="card">
            <div class="card-body text-center text-muted">
                Select a source table to proceed.
            </div>
        </div>

        <h4 class="mt-4">Source Columns</h4>
        <div id="columnList" class="card" style="max-height: 400px; overflow-y: auto;">
            <!-- Columns will be loaded here -->
        </div>
    </div>

    <!-- Right Column: Target Tables -->
    <div class="col-md-4">
        <h3>Target Table <span class="badge bg-info text-dark" style="font-size: 0.6em;">{{ target_conn_name }}</span>
        </h3>
        <div class="mb-3">
            <input type="text" id="targetSearch" class="form-control" placeholder="Search target tables...">
        </div>
        <div class="list-group" id="targetList" style="max-height: 600px; overflow-y: auto;">
            {% for table in target_tables %}
            <div class="list-group-item list-group-item-action target-item" data-name="{{ table.table_name }}"
                style="display: none;">
                <div class="d-flex w-100 justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1">{{ table.table_name }}</h5>
                        <small class="text-muted">{{ table.schema_info | length }} columns</small>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger"
                        onclick="previewDropDDL('{{ table.table_name }}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            {% else %}
            <p class="text-muted ms-2">No target tables defined.</p>
            {% endfor %}
        </div>
    </div>
</div>

<script>
    const sourceTables = {{ source_tables | tojson }};
    const targetTables = {{ target_tables | tojson }};

    // Search Source
    document.getElementById('sourceSearch').addEventListener('keyup', function () {
        filterList('source-item', this.value);
    });

    // Search Target
    document.getElementById('targetSearch').addEventListener('keyup', function () {
        filterList('target-item', this.value);
    });

    function filterList(className, value) {
        const filter = value.toUpperCase().trim();
        document.querySelectorAll('.' + className).forEach(item => {
            if (filter === "") {
                item.style.display = "none";
            } else {
                const txt = item.getAttribute('data-name');
                const comment = item.getAttribute('data-comment') || "";

                const matchName = txt.toUpperCase().indexOf(filter) > -1;
                const matchComment = comment.toUpperCase().indexOf(filter) > -1;

                item.style.display = (matchName || matchComment) ? "" : "none";
            }
        });
    }

    function selectSourceTable(tableName) {
        const sourceTable = sourceTables.find(t => t.table_name === tableName);
        if (!sourceTable) return;

        // Highlight source
        document.querySelectorAll('.source-item').forEach(el => el.classList.remove('active'));
        document.querySelector(`.source-item[data-name="${tableName}"]`).classList.add('active');

        // Check if target exists
        const targetExists = targetTables.find(t => t.table_name === tableName);

        // Render Action Panel
        let actionHtml = `
            <h5 class="card-title">${tableName}</h5>
            <p class="card-text">
                Target Status: 
                ${targetExists ?
                '<span class="badge bg-success">존재함</span>' :
                '<span class="badge bg-secondary">미존재</span>'}
            </p>
            <div class="d-grid gap-2">
                <a href="/mapping" class="btn btn-outline-primary ${!targetExists ? 'disabled' : ''}">Go to Mapping</a>
                <div class="btn-group" role="group">
                    <button type="button" class="btn ${targetExists ? 'btn-warning' : 'btn-primary'} w-100" onclick="previewDDL('${tableName}')">
                        ${targetExists ? 'Recreate Target' : 'Create Target Table'}
                    </button>
                    <button type="button" class="btn btn-danger w-100 ${!targetExists ? 'disabled' : ''}" onclick="previewDropDDL('${tableName}')">
                        Delete Target
                    </button>
                </div>
            </div>
        `;
        document.getElementById('actionPanel').innerHTML = `<div class="card-body">${actionHtml}</div>`;

        // Render Columns
        let colHtml = `
            <table class="table table-sm table-hover mb-0">
                <thead class="table-light">
                    <tr><th>Col</th><th>Desc</th><th>Type</th><th>PK</th><th>Null</th></tr>
                </thead>
                <tbody>
        `;
        sourceTable.columns.forEach(col => {
            colHtml += `
                <tr>
                    <td>${col.name}</td>
                    <td>${col.comment || ''}</td>
                    <td>${col.type}</td>
                    <td>${col.pk ? 'Y' : ''}</td>
                    <td>${col.nullable ? 'Y' : 'N'}</td>
                </tr>
            `;
        });
        colHtml += '</tbody></table>';
        document.getElementById('columnList').innerHTML = colHtml;
    }

    function previewDDL(tableName) {
        // Fetch DDL
        const formData = new FormData();
        formData.append('action', 'generate_ddl');
        formData.append('source_table', tableName);

        fetch('/metadata', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('ddlContent').textContent = data.ddl;

                    // Configure Modal for Create
                    document.getElementById('ddlModalTitle').textContent = 'Create Target Table Preview';

                    // Hide Execute, Show Copy
                    document.getElementById('executeBtn').style.display = 'none';

                    const copyBtn = document.getElementById('copyBtn');
                    copyBtn.style.display = 'block';
                    copyBtn.onclick = function () {
                        navigator.clipboard.writeText(data.ddl).then(() => {
                            alert('클립보드에 복사했어요.');
                        });
                    };

                    document.getElementById('modalAction').value = 'create_target';
                    document.getElementById('modalSourceTable').value = tableName;
                    document.getElementById('modalTargetTable').value = '';

                    new bootstrap.Modal(document.getElementById('ddlModal')).show();
                } else {
                    alert('Failed to generate DDL: ' + data.message);
                }
            })
            .catch(error => console.error('Error:', error));
    }

    function previewDropDDL(tableName) {
        // Fetch Drop DDL
        const formData = new FormData();
        formData.append('action', 'generate_drop_ddl');
        formData.append('target_table', tableName);

        fetch('/metadata', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    document.getElementById('ddlContent').textContent = data.ddl;

                    // Configure Modal for Delete
                    document.getElementById('ddlModalTitle').textContent = 'Delete Target Table Preview';

                    // Hide Execute, Show Copy
                    document.getElementById('executeBtn').style.display = 'none';

                    const copyBtn = document.getElementById('copyBtn');
                    copyBtn.style.display = 'block';
                    copyBtn.onclick = function () {
                        navigator.clipboard.writeText(data.ddl).then(() => {
                            alert('클립보드에 복사했어요.');
                        });
                    };

                    new bootstrap.Modal(document.getElementById('ddlModal')).show();
                } else {
                    alert('Failed to generate Drop DDL: ' + data.message);
                }
            })
            .catch(error => console.error('Error:', error));
    }
</script>

<!-- DDL Preview Modal -->
<div class="modal fade" id="ddlModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ddlModalTitle">DDL Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="ddlContent" class="bg-light p-3 border rounded"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="copyBtn" style="display: none;">Copy DDL</button>
                <form method="POST" action="/metadata" style="display: inline;">
                    <input type="hidden" name="action" id="modalAction">
                    <input type="hidden" name="source_table" id="modalSourceTable">
                    <input type="hidden" name="target_table" id="modalTargetTable">
                    <button type="submit" class="btn btn-primary" id="executeBtn">Execute</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}