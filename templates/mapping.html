{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <h2>Mapping Definition</h2>

    <div class="row mb-4 align-items-end">
        <div class="col-md-3">
            <label class="form-label">Source Table</label>
            <select id="sourceSelect" class="form-select">
                <option value="">Select Source...</option>
                {% for s in sources %}
                <option value="{{ s.table_name }}" data-cols='{{ s.columns | tojson }}'
                    data-comment="{{ s.comment or '' }}">{{ s.table_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-auto text-center px-0">
            <i class="bi bi-arrow-right fs-3"></i>
        </div>
        <div class="col-md-3">
            <label class="form-label">Target Table</label>
            <select id="targetSelect" class="form-select">
                <option value="">Select Target...</option>
                {% for t in targets %}
                <option value="{{ t.table_name }}" data-cols='{{ t.schema_info | tojson }}'>{{ t.table_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <label class="form-label">Mapping Type</label>
            <select id="mappingTypeSelect" class="form-select">
                <option value="1:1">1:1</option>
                <option value="N:1">N:1</option>
            </select>
        </div>
        <div class="col-md-3">
            <button class="btn btn-primary w-100" onclick="generateMapping()">Generate Mapping Definition</button>
        </div>
    </div>

    <div id="mappingArea" style="display:none;">
        <div class="card">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Column Mappings</h5>
                <div class="text-muted small">
                    Source: <span id="selectedSourceInfo" class="fw-bold text-primary"></span>
                    <span class="mx-2">|</span>
                    Target: <span id="selectedTargetInfo" class="fw-bold text-success"></span>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover mb-0" style="font-size: 0.9rem;">
                        <thead class="table-light text-center">
                            <tr>
                                <th colspan="5">Source Column</th>
                                <th colspan="5">Target Column</th>
                                <th colspan="2">Transformation Rule</th>
                                <th>Remarks</th>
                            </tr>
                            <tr>
                                <th>Name</th>
                                <th>Desc</th>
                                <th>Type</th>
                                <th>Null</th>
                                <th>PK</th>
                                <th>Name</th>
                                <th>Desc</th>
                                <th>Type</th>
                                <th>Null</th>
                                <th>PK</th>
                                <th style="width: 15%;">Rule</th>
                                <th style="width: 20%;">Detail</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody id="mappingTableBody">
                            <!-- Rows will be added here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="card-footer">
                <button class="btn btn-primary float-end" onclick="saveMapping()">Save Mapping</button>
            </div>
        </div>
    </div>

    <script>
        function generateMapping() {
            const sourceSelect = document.getElementById('sourceSelect');
            const targetSelect = document.getElementById('targetSelect');
            const mappingType = document.getElementById('mappingTypeSelect').value;

            const sourceOpt = sourceSelect.options[sourceSelect.selectedIndex];
            const targetOpt = targetSelect.options[targetSelect.selectedIndex];

            if (!sourceSelect.value || !targetSelect.value) {
                alert('Please select both source and target tables.');
                return;
            }

            document.getElementById('mappingArea').style.display = 'block';

            // Update Info Header
            const sourceComment = sourceOpt.getAttribute('data-comment');
            document.getElementById('selectedSourceInfo').textContent = sourceSelect.value + (sourceComment ? ` (${sourceComment})` : '');
            document.getElementById('selectedTargetInfo').textContent = targetSelect.value;

            const allSourceCols = JSON.parse(sourceOpt.getAttribute('data-cols'));
            const allTargetCols = JSON.parse(targetOpt.getAttribute('data-cols'));

            const tbody = document.getElementById('mappingTableBody');
            tbody.innerHTML = '';

            allTargetCols.forEach(tCol => {
                const tr = document.createElement('tr');

                // Auto-match logic
                let matchedSCol = allSourceCols.find(s => s.name.toUpperCase() === tCol.name.toUpperCase());

                // Source Column Dropdown
                let optionsHtml = '<option value="">(Select Source)</option>';
                allSourceCols.forEach(col => {
                    const isSelected = matchedSCol && matchedSCol.name === col.name ? 'selected' : '';
                    optionsHtml += `<option value="${col.name}" ${isSelected} data-type="${col.type}"
                    data-null="${col.nullable ? 'Y' : 'N'}" data-pk="${col.pk ? 'Y' : ''}" data-comment="${col.comment || ''}">
                    ${col.name}</option>`;
                });

                const sHtml = `
            <td>
                <select class="form-select form-select-sm source-col-select" onchange="updateSourceInfo(this)">
                    ${optionsHtml}
                </select>
            </td>
            <td class="s-comment">${matchedSCol ? (matchedSCol.comment || '') : ''}</td>
            <td class="s-type">${matchedSCol ? matchedSCol.type : ''}</td>
            <td class="s-null text-center">${matchedSCol ? (matchedSCol.nullable ? 'Y' : 'N') : ''}</td>
            <td class="s-pk text-center">${matchedSCol ? (matchedSCol.pk ? 'Y' : '') : ''}</td>
            `;

                // Target Column Cells
                const tHtml = `
            <td>${tCol.name} <input type="hidden" class="target-col-name" value="${tCol.name}"></td>
            <td>${tCol.comment || ''}</td>
            <td>${tCol.type}</td>
            <td class="text-center">${tCol.nullable ? 'Y' : 'N'}</td>
            <td class="text-center">${tCol.pk ? 'Y' : ''}</td>
            `;

                // Rule Cells
                const ruleHtml = `
            <td>
                <select class="form-select form-select-sm rule-type" onchange="toggleRuleInput(this)">
                    <option value="DIRECT">Direct Copy</option>
                    <option value="NVL">NVL</option>
                    <option value="CUSTOM">Custom SQL</option>
                    <option value="MASKING">Masking</option>
                </select>
            </td>
            <td>
                <input type="text" class="form-control form-select-sm rule-input" style="display:none;" placeholder="">
            </td>
            <td>
                <input type="text" class="form-control form-control-sm remarks-input" placeholder="Remarks">
            </td>
            `;

                tr.innerHTML = sHtml + tHtml + ruleHtml;
                tbody.appendChild(tr);
            });
        }

        function updateSourceInfo(select) {
            const tr = select.closest('tr');
            const opt = select.options[select.selectedIndex];

            if (select.value) {
                tr.querySelector('.s-comment').textContent = opt.getAttribute('data-comment');
                tr.querySelector('.s-type').textContent = opt.getAttribute('data-type');
                tr.querySelector('.s-null').textContent = opt.getAttribute('data-null');
                tr.querySelector('.s-pk').textContent = opt.getAttribute('data-pk');
            } else {
                tr.querySelector('.s-comment').textContent = '';
                tr.querySelector('.s-type').textContent = '';
                tr.querySelector('.s-null').textContent = '';
                tr.querySelector('.s-pk').textContent = '';
            }
        }

        function toggleRuleInput(select) {
            const input = select.closest('td').nextElementSibling.querySelector('input');
            const val = select.value;

            if (val === 'NVL') {
                input.style.display = 'block';
                input.placeholder = 'Default Value (e.g. 0)';
            } else if (val === 'CUSTOM') {
                input.style.display = 'block';
                input.placeholder = 'SQL Expression';
            } else if (val === 'MASKING') {
                input.style.display = 'block';
                input.placeholder = 'Masking Rule (e.g. *******)';
            } else {
                input.style.display = 'none';
                input.value = '';
            }
        }

        function saveMapping() {
            const rows = document.querySelectorAll('#mappingTableBody tr');
            const mappings = [];

            rows.forEach(tr => {
                const sCol = tr.querySelector('.source-col-select').value;
                const tCol = tr.querySelector('.target-col-name').value;
                const rule = tr.querySelector('.rule-type').value;
                const detail = tr.querySelector('.rule-input').value;

                if (tCol) {
                    mappings.push({
                        source_column: sCol,
                        target_column: tCol,
                        rule_type: rule,
                        rule_detail: detail,
                        remarks: tr.querySelector('.remarks-input').value
                    });
                }
            });

            const urlParams = new URLSearchParams(window.location.search);
            const mappingId = urlParams.get('id');

            const data = {
                id: mappingId ? mappingId : null,
                source_table_id: document.getElementById('sourceSelect').value,
                target_table_id: document.getElementById('targetSelect').value,
                mapping_type: document.getElementById('mappingTypeSelect').value,
                mappings: mappings
            };

            fetch('/mapping', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
                .then(r => r.json())
                .then(d => {
                    if (d.status === 'success') {
                        window.location.href = '/mappings';
                    } else {
                        alert('Error saving mapping: ' + (d.message || 'Unknown error'));
                    }
                })
                .catch(e => {
                    console.error(e);
                    alert('Error saving mapping');
                });
        }

        // Check for edit mode on load
        window.onload = function () {
            const urlParams = new URLSearchParams(window.location.search);
            const mappingId = urlParams.get('id');
            if (mappingId) {
                loadMappingForEdit(mappingId);
            }
        };

        function loadMappingForEdit(id) {
            fetch(`/api/mappings/${id}`)
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'success') {
                        const mapping = data.mapping;

                        // Set Source and Target
                        document.getElementById('sourceSelect').value = data.source_table_name;
                        document.getElementById('targetSelect').value = data.target_table_name;

                        // Set Mapping Type
                        if (mapping.type) {
                            document.getElementById('mappingTypeSelect').value = mapping.type;
                        }

                        // Generate the table rows
                        generateMapping();

                        // Populate rows with saved data
                        const rows = document.querySelectorAll('#mappingTableBody tr');
                        const savedMappings = mapping.mappings;

                        rows.forEach(tr => {
                            const tCol = tr.querySelector('.target-col-name').value;
                            const saved = savedMappings.find(m => m.target_column === tCol);

                            if (saved) {
                                // Set Source Column
                                const sSelect = tr.querySelector('.source-col-select');
                                sSelect.value = saved.source_column;
                                updateSourceInfo(sSelect); // Update source details

                                // Set Rule
                                const rSelect = tr.querySelector('.rule-type');
                                rSelect.value = saved.rule_type;
                                toggleRuleInput(rSelect); // Show/hide input

                                // Set Rule Detail
                                const rInput = tr.querySelector('.rule-input');
                                rInput.value = saved.rule_detail || '';

                                // Set Remarks
                                tr.querySelector('.remarks-input').value = saved.remarks || '';
                            }
                        });

                    } else {
                        alert('Error loading mapping: ' + data.message);
                    }
                })
                .catch(e => {
                    console.error(e);
                    alert('Error loading mapping details');
                });
        }
    </script>
    {% endblock %}